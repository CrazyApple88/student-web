/*! plug-1.0.0.js 2018-02-03 10:11:30 */

!function(e){e.fn.UploadFile=function(e){return l.init(e)};var i="",l={_file:null,btnId:"#upload",uploadUrl:"",listUrl:"",delUrl:"",fileType:"",fileSize:"20M",formParams:{},fileId:"fileId",formId:"formId",businessId:"",filepath:"upload",moreFile:!1,uploadsuccess:function(e){},uploaderror:function(e){},templateInit:function(e){},init:function(l){var t=this;e.extend(this,l);var o=e(t.btnId);o.after('<div id="file_box" style="display:none"><input type="file"  id="fileId"/></div>');var a=o.siblings("#file_box").find("input[type=file][id=fileId]")[0];return this._file=a,o.on("click",function(){e(a).trigger("click")}),e(a).change(function(){t.uploadevent(a)}),t.initList(),i=UDP.Public.getmessage("upload.errorMsg",t.filepath,"当前网络异常,请稍后再试!"),this},uploadevent:function(i){var l=this,t=i.files;""!=e(i).val()&&window.setTimeout(function(){for(var e=i.files[0].size,o=0;o<t.length;o++){var a=l.limitFormat(i),r=l.limitFileSize(e);if(!a||!r||!a&&!r)return void delete i.files[o];l.upload(i)}},10)},limitFileSize:function(e){var i=this,l=1024*parseFloat(i.fileSize);if(UDP.Public.Bytetransform(e),e>l){var t=UDP.Public.getmessage("upload.sizeerrMsg",i.filepath,"文件太大无法上传！");return i.uploaderror(t),!1}return!0},limitFormat:function(e){var i=this,l=e.files[0].name,t=l.indexOf("."),o=l.substring(t+1);if(i.fileType.indexOf(o)<0){var a=UDP.Public.getmessage("upload.formaterrMsg",i.filepath,"上传格式不正确！");return i.uploaderror(a),!1}return!0},uploadprogress:function(){e("#uploadfile_list").prepend('<li class="filepro_cont"><div class="filesize"><span class="upload_num">0M</span> / <span class="file_num">0M</span></div><div class="pregress_cont"> <div class="upload_progress"></div></div></li>')},upload:function(l){var t=this,o=t.uploadUrl,a=new FormData;a.append("file",l.files[0]),t.uploadprogress();var r=new XMLHttpRequest;r.upload.addEventListener("progress",function(i){var l=UDP.Public.Bytetransform(i.total),t=UDP.Public.Bytetransform(i.loaded),o=i.loaded/i.total*100;e(".upload_num").html(t),e(".file_num").html(l),e(".pregress_cont").find(".upload_progress").css("width",o+"%")},!1),r.addEventListener("load",function(i){var l="",o=i.target.responseText;if("string"==typeof o)try{l=JSON.parse(o)}catch(i){return alert("上传失败，请重试!"),e(".filepro_cont").remove(),!1}if("1"!==l.code){if("nologin"===l.msg){var a=UDP.Public.getmessage("upload.loaderrorMsg.loginerrorMsg",t.filepath,"登陆异常，请重新登录!");return t.uploaderror(a),e(".filepro_cont").remove(),!1}a=UDP.Public.getmessage("upload.loaderrorMsg.othererrorMsg",t.filepath,"操作失败，请重试!");return t.uploaderror(a),e(".filepro_cont").remove(),!1}var r=t.fileListtemplate(l.data[0]);e("li[data-type]").remove(),e("#uploadfile_list").append(r),e("[del]","#uploadfile_list").on("click",function(){t.delFile(e(this).attr("del"))}),e("[load]","#uploadfile_list").on("click",function(){t.loadFile(e(this).attr("fileurl"))}),e(".filepro_cont").remove(),t.uploadsuccess(l)},!1),r.addEventListener("error",function(l){if(0==l.currentTarget.status)t.uploaderror(i),e(".filepro_cont").remove();else{t.uploaderror("file:upload error!"),e(".filepro_cont").remove()}},!1),r.open("post",o,!0);var n=l.files[0].name;r.setRequestHeader("X_FILENAME",unescape(encodeURIComponent(n))),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.send(a)},fileListtemplate:function(e,i){this.templateInit(e)},initList:function(){var i=this.listUrl,l=this,t="";return e.ajax({url:i,type:"post",async:!1,dataType:"json",success:function(i){if(""==i.data&&l.noFiledata(),"1"==i.code){var o=i.data;l.templateInit(o),e("[del]","#uploadfile_list").on("click",function(){l.delFile(e(this).attr("del"))}),e("[load]","#uploadfile_list").on("click",function(){l.loadFile(e(this).attr("fileurl"))})}return t=i}}),t},delFile:function(i){var l=this,t=l.delUrl+"/"+i;e.ajax({url:t,type:"post",async:!1,dataType:"json",success:function(t){"1"==t.code&&e("#file"+i).fadeOut(function(){e("#file"+i).remove(),0==e("#uploadfile_list li").length&&l.noFiledata()})}})},loadFile:function(e){window.location=e},noFiledata:function(){var i='<li data-type="no-datas">'+UDP.Public.getmessage("upload.upload.nodataMsg",this.filepath,"暂无数据")+"</li>";return e("#uploadfile_list").append(i),i}};!function(i){i.UDP?i.UDP.Uploadfile=e.fn.UploadFile:i.UDP={Uploadfile:e.fn.UploadFile};i.UDP.Public.PlugList({fileType:"plug",filename:"upload"})}(window)}(jQuery);